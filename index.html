<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard RRHH - Gr√°ficos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <style>
        /* --- ESTILOS CSS --- */
        :root {
            /* Tema Claro (default) */
            --primary: #007bff;
            --bg: #f4f6f9;
            --card-bg: #ffffff;
            --border: #dee2e6;
            --text-main: #343a40;
            --text-secondary: #6c757d;
            --gradient-bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --color-celeste: #29b6f6; 
            --color-verde: #28a745; 
            --color-rojo: #dc3545; 
            --color-amarillo: #ffc107; 
            --color-gris: #6c757d; 
        }
        
        /* Tema Oscuro */
        [data-theme="dark"] {
            --primary: #aea1ff;
            --bg: #1a1a2e;
            --card-bg: #16213e;
            --border: #2d3748;
            --text-main: #e2e8f0;
            --text-secondary: #a0aec0;
            --gradient-bg: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
        }
        
        /* Transici√≥n suave al cambiar de tema */
        body, .container, .chart-box, .action-button {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body {
            font-family: 'Roboto', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            
            background-color: var(--bg);
            padding: 5px 8px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            color: var(--text-main);
        }

        .container {
            width: 100%;
            max-width: 98%;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden; 
            box-sizing: border-box;
        }

        h3 { 
            color: var(--text-main); 
            padding-bottom: 8px; 
            margin-bottom: 20px; 
            font-size: 1.4rem;
            font-weight: 500;
        }

        /* Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Animaciones de entrada */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Contenedor de datos */
        .datos-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .dato-card {
            background: linear-gradient(135deg, var(--card-bg) 0%, rgba(255,255,255,0.95) 100%);
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.04);
            animation: fadeInUp 0.5s ease-out;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0,0,0,0.04);
            position: relative;
            overflow: hidden;
        }

        .dato-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .dato-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 60px rgba(0,0,0,0.12), 0 4px 16px rgba(0,0,0,0.08);
        }

        .dato-card:hover::before {
            opacity: 1;
        }

        .dato-card h3 {
            color: var(--text-main);
            margin: 0 0 27px 0;
            font-size: 1.26rem;
            text-align: center;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .chart-wrapper {
            max-width: 288px;
            margin: 0 auto;
            padding: 18px;
            position: relative;
        }

        .chart-wrapper canvas {
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.1));
        }

        .tabla-conformidad {
            width: 100%;
            border-collapse: collapse;
        }

        .tabla-conformidad th,
        .tabla-conformidad td {
            padding: 22px 13px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .tabla-conformidad th {
            background: var(--bg);
            color: var(--text-main);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.86rem;
            letter-spacing: 0.5px;
        }

        .tabla-conformidad td {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .porcentaje {
            font-weight: 700;
            font-size: 1.26rem;
            color: var(--primary);
        }

        .badge-conforme {
            display: inline-block;
            padding: 4px 11px;
            border-radius: 11px;
            background: #e6f7ed;
            color: #0d7337;
            font-weight: 600;
            font-size: 0.81rem;
        }

        .badge-disconforme {
            display: inline-block;
            padding: 4px 11px;
            border-radius: 11px;
            background: #fff3e6;
            color: #d97706;
            font-weight: 600;
            font-size: 0.81rem;
        }

        @media (max-width: 768px) {
            .datos-container {
                grid-template-columns: 1fr;
            }
        }

        /* Botones de Acci√≥n */
        .botones-accion {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
            flex-wrap: wrap;
        }

        .btn-accion {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 18px 48px;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            font-family: 'Roboto', sans-serif;
            min-width: 200px;
            justify-content: center;
        }

        .btn-accion:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .btn-accion:active {
            transform: translateY(-1px);
        }

        .btn-pendientes {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .btn-pendientes:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }

        .btn-firmados {
            background: linear-gradient(135deg, #43e97b 0%, #38d172 100%);
            color: white;
        }

        .btn-firmados:hover {
            background: linear-gradient(135deg, #38d172 0%, #2fb564 100%);
        }

        .btn-cargar {
            background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
            color: white;
        }

        .btn-cargar:hover {
            background: linear-gradient(135deg, #9333ea 0%, #6b21a8 100%);
        }

        /* Estilos para la informaci√≥n del token */
        .token-info-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .token-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            animation: fadeInUp 0.5s ease-out forwards;
        }

        .token-card h3 {
            color: var(--primary);
            margin: 0 0 20px 0;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .token-field {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .token-field:last-child {
            border-bottom: none;
        }

        .token-field-label {
            font-weight: 600;
            color: var(--text-primary);
            min-width: 180px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .token-field-value {
            color: var(--text-secondary);
            flex: 1;
            word-break: break-word;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.95rem;
        }

        .token-field-value.highlight {
            color: var(--primary);
            font-weight: 600;
        }

        .token-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .token-status.valid {
            background: #e6f7ed;
            color: #0d7337;
        }

        .token-status.expired {
            background: #ffe6e6;
            color: #d32f2f;
        }

        .token-raw {
            background: var(--bg-color);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        .token-json {
            background: var(--bg-color);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        .token-json pre {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* Media Queries para responsividad */
        @media (max-width: 768px) {
            body { padding: 20px; }
            .container { padding: 20px; }
            .charts-container { grid-template-columns: 1fr; }
            .token-field {
                flex-direction: column;
                gap: 5px;
            }
            .token-field-label {
                min-width: auto;
            }
        }
        @media (max-width: 1200px) and (min-width: 769px) {
            .charts-container { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

<div class="container">
    <h2 style="color: var(--text-main); margin-bottom: 30px; text-align: left;">Mi resumen</h2>
    
    <div id="loadingMessage" style="text-align: center; padding: 40px; color: var(--text-secondary);">
        <div class="loader"></div>
        <p style="margin-top: 20px;">Cargando datos...</p>
    </div>

    <div id="datosContainer" class="datos-container" style="display: none;">
        <!-- Gr√°fico de Firmado -->
        <div class="dato-card">
            <h3>Estado de Firma</h3>
            <div class="chart-wrapper">
                <canvas id="chartFirmado"></canvas>
            </div>
        </div>

        <!-- Tabla de Conformidad -->
        <div class="dato-card">
            <h3>Conformidad</h3>
            <table id="tablaConformidad" class="tabla-conformidad">
                <thead>
                    <tr>
                        <th>Estado</th>
                        <th>Cantidad</th>
                        <th>Porcentaje</th>
                    </tr>
                </thead>
                <tbody id="tablaConformidadBody">
                    <!-- Se llenar√° din√°micamente -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Botones de Acci√≥n -->
    <div id="botonesAccion" class="botones-accion" style="display: none;">
        <button class="btn-accion btn-pendientes" onclick="irAPendientes()">
            Ir a Pendientes
        </button>
        <button class="btn-accion btn-firmados" onclick="irAFirmados()">
            Ir a Firmados
        </button>
        <button class="btn-accion btn-cargar" onclick="cargarDocumento()">
            Cargar documento
        </button>
    </div>

</div>

<script>
    
    // ========== EXTRACCI√ìN DE TOKEN ==========
    
    /**
     * Extrae el par√°metro token de la URL
     */
    function obtenerToken() {
        const params = new URLSearchParams(window.location.search);
        const token = params.get("token");
        
        console.log('üîë Token obtenido de la URL');
        return token;
    }
    
    /**
     * Decodifica un token JWT (JSON Web Token)
     * Los JWT tienen formato: header.payload.signature
     * Cada parte est√° codificada en Base64
     */
    function decodificarToken(token) {
        if (!token) {
            console.warn('‚ö†Ô∏è No hay token para decodificar');
            return null;
        }

        try {
            // Los JWT tienen 3 partes separadas por puntos
            const partes = token.split('.');
            
            if (partes.length !== 3) {
                console.warn('‚ö†Ô∏è El token no tiene el formato JWT est√°ndar (3 partes)');
                // Intentar decodificar como Base64 simple
                return decodificarBase64Simple(token);
            }

            // Decodificar el payload (segunda parte)
            const payload = partes[1];
            const payloadDecodificado = decodificarBase64(payload);
            
            // Decodificar el header (primera parte) - opcional
            const header = partes[0];
            const headerDecodificado = decodificarBase64(header);
            
            const tokenInfo = {
                header: headerDecodificado,
                payload: payloadDecodificado,
                signature: partes[2],
                raw: token
            };
            
            return tokenInfo;
            
        } catch (error) {
            console.error('‚ùå Error al decodificar token:', error);
            return null;
        }
    }

    /**
     * Decodifica una cadena Base64 (compatible con Base64URL usado en JWT)
     */
    function decodificarBase64(base64String) {
        try {
            // Reemplazar caracteres Base64URL por Base64 est√°ndar
            let base64 = base64String.replace(/-/g, '+').replace(/_/g, '/');
            
            // Agregar padding si es necesario
            while (base64.length % 4 !== 0) {
                base64 += '=';
            }
            
            // Decodificar de Base64 a string
            const decoded = atob(base64);
            
            // Intentar parsear como JSON
            try {
                return JSON.parse(decoded);
            } catch (e) {
                // Si no es JSON, devolver el string decodificado
                return decoded;
            }
        } catch (error) {
            console.error('Error en decodificarBase64:', error);
            return null;
        }
    }

    /**
     * Intenta decodificar una cadena Base64 simple (no JWT)
     */
    function decodificarBase64Simple(cadena) {
        try {
            const decoded = decodificarBase64(cadena);
            console.log('üîì Cadena Base64 decodificada:', decoded);
            return { payload: decoded, raw: cadena };
        } catch (error) {
            console.error('‚ùå Error al decodificar cadena Base64:', error);
            return null;
        }
    }

    /**
     * Extrae informaci√≥n √∫til del payload del token
     */
    function obtenerInfoToken(tokenDecodificado) {
        if (!tokenDecodificado || !tokenDecodificado.payload) {
            return null;
        }

        const payload = tokenDecodificado.payload;
        const info = {
            usuario: payload.sub || payload.user || payload.username || payload.email,
            roles: payload.roles || payload.role || payload.permissions,
            expiracion: payload.exp ? new Date(payload.exp * 1000) : null,
            emision: payload.iat ? new Date(payload.iat * 1000) : null,
            payload: payload
        };

        if (info.expiracion) {
            const ahora = new Date();
            info.expirado = ahora > info.expiracion;
            info.tiempoRestante = info.expiracion - ahora;
        }

        return info;
    }
    
    // Obtener token al cargar la p√°gina
    const TOKEN = obtenerToken();
    const TOKEN_DECODIFICADO = decodificarToken(TOKEN);
    const INFO_TOKEN = obtenerInfoToken(TOKEN_DECODIFICADO);
    const LIBRARY = '32a76e80-1d2d-47fe-9b9d-d423cf644d68';
    let LEGAJO = null; // Variable global para almacenar el legajo
    
    // Validar token
    if (TOKEN && INFO_TOKEN) {
        if (INFO_TOKEN.expirado) {
            console.warn('‚ö†Ô∏è El token ha expirado');
        }
    }

    /**
     * Muestra la informaci√≥n del token en la interfaz
     */
    function mostrarInfoToken() {
        const container = document.getElementById('tokenInfoDisplay');
        if (!container) return;

        if (!TOKEN) {
            container.innerHTML = `
                <div class="token-card">
                    <p style="text-align: center; color: var(--text-secondary);">
                        ‚ö†Ô∏è No se encontr√≥ ning√∫n token en la URL
                    </p>
                </div>
            `;
            return;
        }

        let html = '';

        // Informaci√≥n principal del token
        if (INFO_TOKEN) {
            const estadoToken = INFO_TOKEN.expirado ? 
                '<span class="token-status expired">‚ùå Expirado</span>' : 
                '<span class="token-status valid">‚úÖ V√°lido</span>';

            html += `
                <div class="token-card">
                    <h3>üìã Informaci√≥n Principal</h3>
                    
                    ${INFO_TOKEN.usuario ? `
                    <div class="token-field">
                        <div class="token-field-label">üë§ Usuario:</div>
                        <div class="token-field-value highlight">${INFO_TOKEN.usuario}</div>
                    </div>
                    ` : ''}
                    
                    ${INFO_TOKEN.roles ? `
                    <div class="token-field">
                        <div class="token-field-label">üîê Roles/Permisos:</div>
                        <div class="token-field-value">${Array.isArray(INFO_TOKEN.roles) ? INFO_TOKEN.roles.join(', ') : INFO_TOKEN.roles}</div>
                    </div>
                    ` : ''}
                    
                    ${INFO_TOKEN.emision ? `
                    <div class="token-field">
                        <div class="token-field-label">üìÖ Fecha de Emisi√≥n:</div>
                        <div class="token-field-value">${INFO_TOKEN.emision.toLocaleString('es-AR')}</div>
                    </div>
                    ` : ''}
                    
                    ${INFO_TOKEN.expiracion ? `
                    <div class="token-field">
                        <div class="token-field-label">‚è∞ Fecha de Expiraci√≥n:</div>
                        <div class="token-field-value">${INFO_TOKEN.expiracion.toLocaleString('es-AR')}</div>
                    </div>
                    ` : ''}
                    
                    <div class="token-field">
                        <div class="token-field-label">üìä Estado:</div>
                        <div class="token-field-value">${estadoToken}</div>
                    </div>
                    
                    ${INFO_TOKEN.tiempoRestante && !INFO_TOKEN.expirado ? `
                    <div class="token-field">
                        <div class="token-field-label">‚è±Ô∏è Tiempo Restante:</div>
                        <div class="token-field-value highlight">${Math.floor(INFO_TOKEN.tiempoRestante / 60000)} minutos</div>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        // Payload completo decodificado
        if (TOKEN_DECODIFICADO && TOKEN_DECODIFICADO.payload) {
            html += `
                <div class="token-card">
                    <h3>üîç Payload Completo (JSON)</h3>
                    <div class="token-json">
                        <pre>${JSON.stringify(TOKEN_DECODIFICADO.payload, null, 2)}</pre>
                    </div>
                </div>
            `;
        }

        // Token original (raw)
        html += `
            <div class="token-card">
                <h3>üîê Token Original (Raw)</h3>
                <div class="token-raw">${TOKEN}</div>
            </div>
        `;

        container.innerHTML = html;
    }

    /**
     * Obtiene datos del usuario desde el endpoint enviando todo el token decodificado
     */
    async function obtenerDatosUsuario() {
        console.log('üöÄ INICIANDO obtenerDatosUsuario()...');
        
        try {
            // Verificar que haya token en la URL
            if (!TOKEN) {
                console.error('‚ùå No se encontr√≥ token en la URL');
                document.getElementById('loadingMessage').innerHTML = `
                    <p style="color: orange;">‚ö†Ô∏è No se encontr√≥ token en la URL</p>
                    <p style="font-size: 0.9rem;">Para usar este dashboard, debe acceder mediante un enlace con token v√°lido.</p>
                `;
                return null;
            }
            
            // Verificar que el token est√© decodificado
            if (!TOKEN_DECODIFICADO || !TOKEN_DECODIFICADO.payload) {
                console.error('‚ùå No hay token decodificado disponible');
                document.getElementById('loadingMessage').innerHTML = `
                    <p style="color: red;">‚ùå Error al decodificar token</p>
                    <p style="font-size: 0.9rem;">El token proporcionado no es v√°lido o est√° mal formado.</p>
                `;
                return null;
            }

            // Preparar datos a enviar: payload decodificado + token original
            const dataToSend = {
                payload: TOKEN_DECODIFICADO.payload,
                token: TOKEN
            };
            
            const endpoint = 'https://square-regular-honeybee.ngrok-free.app/webhook/Dashboard_user_rrhh';
            
            console.log('‚è≥ Obteniendo datos del usuario...');

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true'
                },
                body: JSON.stringify(dataToSend)
            });

            console.log('üì• Respuesta recibida');

            if (!response.ok) {
                const errorText = await response.text();
                console.error('‚ùå Error en la respuesta:', errorText);
                throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
            }

            // Leer la respuesta como texto primero para verificar
            const responseText = await response.text();
            
            // Verificar que no est√© vac√≠a
            if (!responseText || responseText.trim() === '') {
                console.error('‚ùå La respuesta del servidor est√° vac√≠a');
                console.error('‚ö†Ô∏è POSIBLES CAUSAS:');
                console.error('   1. El endpoint no est√° procesando la petici√≥n correctamente');
                console.error('   2. El servidor esperaba un formato diferente en el body');
                console.error('   3. Hay un error en el servidor que no est√° devolviendo nada');
                console.error('   4. El endpoint necesita autenticaci√≥n adicional');
                
                // Mostrar opciones al usuario
                document.getElementById('loadingMessage').innerHTML = `
                    <p style="color: orange;">‚ö†Ô∏è El servidor no devolvi√≥ datos</p>
                    <p style="font-size: 0.9rem;">El endpoint est√° respondiendo pero no est√° devolviendo informaci√≥n.</p>
                    <p style="font-size: 0.9rem;">Verifica la consola del servidor para m√°s detalles.</p>
                `;
                
                throw new Error('El servidor devolvi√≥ una respuesta vac√≠a');
            }
            
            // Intentar parsear como JSON
            let responseData;
            try {
                responseData = JSON.parse(responseText);
            } catch (parseError) {
                console.error('‚ùå La respuesta no es un JSON v√°lido:', parseError);
                console.error('üìÑ Contenido completo de la respuesta:', responseText);
                throw new Error('La respuesta del servidor no es un JSON v√°lido');
            }
            
            // Validar que la respuesta sea un array y tenga elementos
            if (!Array.isArray(responseData) || responseData.length === 0) {
                console.error('‚ùå La respuesta no es un array v√°lido o est√° vac√≠a:', responseData);
                throw new Error('Respuesta inv√°lida: se esperaba un array con datos');
            }
            
            // Extraer el legajo y parsear los datos
            const legajo = responseData[0]?.legajo;
            const datosString = responseData[0]?.datos;
            
            console.log('üìã Legajo extra√≠do');
            
            // Validar que datosString exista antes de parsear
            if (!datosString) {
                console.error('‚ùå No se encontr√≥ el campo "datos" en la respuesta');
                throw new Error('Campo "datos" no encontrado en la respuesta');
            }
            
            // Parsear los datos
            let data;
            try {
                data = JSON.parse(datosString);
                console.log('üìä Datos parseados exitosamente');
            } catch (parseError) {
                console.error('‚ùå Error al parsear el JSON de datos:', parseError);
                console.error('String que intent√≥ parsear:', datosString);
                throw new Error('Error al parsear el campo datos: ' + parseError.message);
            }
            
            // Verificar si los datos est√°n vac√≠os
            if (!data || Object.keys(data).length === 0) {
                console.warn('‚ö†Ô∏è No hay datos disponibles para mostrar');
                
                // Ocultar loading y mostrar mensaje
                document.getElementById('loadingMessage').innerHTML = `
                    <p style="color: var(--text-secondary); font-size: 1.2rem; margin-bottom: 10px;">üìã A√∫n no tiene datos disponibles</p>
                    <p style="color: var(--text-secondary); font-size: 0.95rem;">No se encontraron registros para su usuario en este momento.</p>
                `;
                
                return null;
            }
            
            // Renderizar los datos (incluso si algunos campos est√°n vac√≠os)
            renderizarDatos(data, legajo);
            
            return data;

        } catch (error) {
            console.error('‚ùå Error al obtener datos del usuario:', error);
            console.error('Tipo de error:', error.name);
            console.error('Mensaje de error:', error.message);
            console.error('Stack trace:', error.stack);
            
            // Mostrar error en la UI con m√°s detalles
            let errorMsg = error.message;
            let sugerencia = '';
            
            // Detectar tipo de error y dar sugerencias
            if (error.name === 'TypeError' && error.message.includes('fetch')) {
                errorMsg = 'No se pudo conectar con el servidor';
                sugerencia = 'Verifica que el servidor est√© activo y que la URL de ngrok sea correcta.';
            } else if (error.message.includes('NetworkError')) {
                errorMsg = 'Error de conexi√≥n de red';
                sugerencia = 'Revisa tu conexi√≥n a Internet o la configuraci√≥n del servidor.';
            }
            
            document.getElementById('loadingMessage').innerHTML = `
                <p style="color: red;">‚ùå Error al cargar los datos</p>
                <p style="font-size: 0.9rem;">${errorMsg}</p>
                ${sugerencia ? `<p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 10px;">${sugerencia}</p>` : ''}
                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 15px;">üìã Abre la consola del navegador (F12) para m√°s detalles.</p>
            `;
            
            return null;
        }
    }

    /**
     * Renderiza los datos recibidos del servidor
     */
    function renderizarDatos(data, legajo) {
        // Guardar legajo en variable global
        LEGAJO = legajo;
        console.log('üîó Legajo disponible para callback:', legajo);

        // Ocultar loading y mostrar contenedores
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('datosContainer').style.display = 'grid';
        document.getElementById('botonesAccion').style.display = 'flex'; // Los botones siempre se muestran

        // Renderizar gr√°fico de firmado (siempre intentar, aunque sea vac√≠o)
        if (data && data.firmado) {
            renderizarGraficoFirmado(data.firmado);
        } else {
            // Si no hay datos de firmado, mostrar mensaje
            document.querySelector('#chartFirmado').parentElement.innerHTML = '<p style="text-align: center; color: var(--text-secondary); font-size: 1.1rem; padding: 40px 20px;">üìã A√∫n no hay registros</p>';
        }

        // Renderizar tabla de conformidad
        if (data && data.conformidad) {
            renderizarTablaConformidad(data.conformidad);
        }
    }

    let chartFirmadoInstance = null;

    /**
     * Renderiza el gr√°fico circular de firmado
     */
    function renderizarGraficoFirmado(firmadoData) {
        // Preparar datos: asegurar que tengamos Si y Pendiente
        const dataMap = {};
        firmadoData.forEach(item => {
            dataMap[item.label] = item.value;
        });

        const si = dataMap['Si'] || 0;
        const pendiente = dataMap['Pendiente'] || 0;
        const total = si + pendiente;

        if (total === 0) {
            document.querySelector('#chartFirmado').parentElement.innerHTML = '<p style="text-align: center; color: var(--text-secondary); font-size: 1.1rem; padding: 40px 20px;">üìã A√∫n no hay registros</p>';
            return;
        }

        // Filtrar solo valores mayores a 0 para evitar l√≠neas en 0%
        const chartData = [];
        const chartLabels = [];
        const chartColors = [];
        
        if (si > 0) {
            chartLabels.push('Firmados');
            chartData.push(si);
            chartColors.push('rgba(67, 233, 123, 0.9)');
        }
        
        if (pendiente > 0) {
            chartLabels.push('Pendiente');
            chartData.push(pendiente);
            chartColors.push('rgba(59, 130, 246, 0.9)');
        }

        const ctx = document.getElementById('chartFirmado').getContext('2d');
        
        if (chartFirmadoInstance) {
            chartFirmadoInstance.destroy();
        }

        // Si solo hay un valor (100%), no mostrar borde
        const borderWidth = chartData.length === 1 ? 0 : 3;

        chartFirmadoInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: chartLabels,
                datasets: [{
                    data: chartData,
                    backgroundColor: chartColors,
                    borderColor: 'white',
                    borderWidth: borderWidth,
                    hoverOffset: 15,
                    hoverBorderWidth: chartData.length === 1 ? 0 : 3,
                    hoverBorderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            font: {
                                size: 14,
                                weight: '600',
                                family: 'Roboto'
                            },
                            usePointStyle: true,
                            pointStyle: 'circle',
                            boxWidth: 10,
                            boxHeight: 10
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        cornerRadius: 8,
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13
                        },
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed;
                                const percentage = ((value / total) * 100).toFixed(1);
                                return ` ${context.label}: ${value} (${percentage}%)`;
                            }
                        }
                    },
                    datalabels: {
                        color: '#fff',
                        font: {
                            weight: 'bold',
                            size: 16
                        },
                        formatter: (value, ctx) => {
                            const percentage = ((value / total) * 100).toFixed(1);
                            return percentage + '%';
                        },
                        anchor: 'center',
                        align: 'center'
                    }
                },
                animation: {
                    animateRotate: true,
                    animateScale: true,
                    duration: 1200,
                    easing: 'easeInOutQuart'
                }
            },
            plugins: [ChartDataLabels]
        });

        console.log('‚úÖ Gr√°fico de firmado renderizado:', {firmados: si, pendiente});
    }

    /**
     * Renderiza la tabla de conformidad con porcentajes
     */
    function renderizarTablaConformidad(conformidadData) {
        // Preparar datos: asegurar que tengamos Conforme y Disconforme
        const dataMap = {};
        conformidadData.forEach(item => {
            dataMap[item.label] = item.value;
        });

        const conforme = dataMap['Conforme'] || 0;
        const disconforme = dataMap['Disconforme'] || 0;
        const total = conforme + disconforme;

        if (total === 0) {
            document.getElementById('tablaConformidadBody').innerHTML = '<tr><td colspan="3" style="text-align: center;">No hay datos disponibles</td></tr>';
            return;
        }

        const porcentajeConforme = ((conforme / total) * 100).toFixed(1);
        const porcentajeDisconforme = ((disconforme / total) * 100).toFixed(1);

        const tbody = document.getElementById('tablaConformidadBody');
        tbody.innerHTML = `
            <tr>
                <td><span class="badge-conforme">Conforme</span></td>
                <td>${conforme}</td>
                <td><span class="porcentaje">${porcentajeConforme}%</span></td>
            </tr>
            <tr>
                <td><span class="badge-disconforme">Disconforme</span></td>
                <td>${disconforme}</td>
                <td><span class="porcentaje">${porcentajeDisconforme}%</span></td>
            </tr>
        `;

        console.log('‚úÖ Tabla de conformidad renderizada:', {conforme, disconforme});
    }

    /**
     * Funciones de navegaci√≥n
     */
    function irAPendientes() {
        console.log('‚è∞ Navegando a Pendientes de Firma...');
        const callback = `/widgets/query?filter=%7B%22combinator%22%3A%22and%22%2C%22rules%22%3A%5B%7B%22id%22%3A%22066fe4f6-ae63-4bad-ac31-b5eb007fe4b4%22%2C%22rules%22%3A%5B%7B%22id%22%3A%227d4607d4-111b-4956-b0a3-24466c952d33%22%2C%22field%22%3A%22firmado%22%2C%22operator%22%3A%22null%22%2C%22valueSource%22%3A%22value%22%2C%22value%22%3A%22%22%7D%2C%7B%22id%22%3A%22a1181c9b-569c-4180-a9d0-2c3b1d85efb1%22%2C%22field%22%3A%22firmado%22%2C%22operator%22%3A%22%3D%22%2C%22valueSource%22%3A%22value%22%2C%22value%22%3A%22No%22%7D%2C%7B%22id%22%3A%22cad87220-ff3b-47e6-8856-33612b51c47d%22%2C%22field%22%3A%22firmado%22%2C%22operator%22%3A%22%3D%22%2C%22valueSource%22%3A%22value%22%2C%22value%22%3A%22NO%22%7D%5D%2C%22combinator%22%3A%22or%22%2C%22not%22%3Afalse%7D%2C%7B%22id%22%3A%2280ae0ad8-ea5e-44c2-96ac-aaa38f80b944%22%2C%22rules%22%3A%5B%7B%22id%22%3A%22359e5aa4-9797-4a29-b594-486bbb88899d%22%2C%22field%22%3A%22object_definition_id%22%2C%22operator%22%3A%22%3D%22%2C%22valueSource%22%3A%22value%22%2C%22value%22%3A%226f5abc1c-24fe-4010-94fe-1771191ebc90%22%7D%2C%7B%22id%22%3A%22ae19010b-68f1-443c-9ead-1674381b4bd9%22%2C%22field%22%3A%22legajo%22%2C%22operator%22%3A%22%3D%22%2C%22valueSource%22%3A%22value%22%2C%22value%22%3A%220001%22%7D%5D%2C%22combinator%22%3A%22and%22%2C%22not%22%3Afalse%7D%5D%7D&title=B%C3%BAsqueda+avanzada&sort=%5B%22created_at+desc%22%5D&disableFilter=true&showAddButton=false`;
        const url = `https://ecm-web-desktop.aditus-demo.com.ar/loginWithToken?library=${encodeURIComponent(LIBRARY)}&token=${encodeURIComponent(TOKEN)}&callback=${callback}`;
        window.location.href = url;
    }

    function irAFirmados() {
        console.log('‚úÖ Navegando a Firmados...');
        const callback = `/widgets/query?filter=%7B%22combinator%22%3A%22and%22%2C%22rules%22%3A%5B%7B%22id%22%3A%2238bca70a-fdb9-42bc-ae7e-c3e8cf344dd1%22%2C%22field%22%3A%22object_definition_id%22%2C%22operator%22%3A%22%3D%22%2C%22valueSource%22%3A%22value%22%2C%22value%22%3A%22c67cdebf-2665-408a-90d3-fd74ad528dc1%22%7D%2C%7B%22id%22%3A%2251506304-8895-4bab-9d03-1cc5544d283b%22%2C%22field%22%3A%22legajo%22%2C%22operator%22%3A%22%3D%22%2C%22valueSource%22%3A%22value%22%2C%22value%22%3A%220001%22%7D%5D%7D&title=B%C3%Recibos+Firmados&sort=%5B%22created_at+desc%22%5D&disableFilter=true&showAddButton=false`;
        const url = `https://ecm-web-desktop.aditus-demo.com.ar/loginWithToken?library=${encodeURIComponent(LIBRARY)}&token=${encodeURIComponent(TOKEN)}&callback=${callback}`;
        window.location.href = url;
    }

    function cargarDocumento() {
        console.log('üìÑ Navegando a Cargar documento...');
        const options = {
            hide: ["legajo"],  
            sort: ["object_title","tipo_de_documento", "descripcion"],
            required: ["object_title","tipo_de_documento", "descripcion"],
            choices: {
                tipo_de_documento: [
                    { value: "DNI", display: "DNI" },
                    { value: "Certificado m√©dico", display: "Certificado m√©dico" },
                    { value: "Certificado universitario", display: "Certificado universitario" },
                    { value: "Vacaciones", display: "Vacaciones" }
                ]
            }
        };
        const objectDefinitionId = '414ebce5-9a05-4970-8d10-bb9e4b7a209f';
        const callback = `/widgets/create/${objectDefinitionId}?options=${encodeURIComponent(JSON.stringify(options))}`; 
        const url = `https://ecm-web-desktop.aditus-demo.com.ar/loginWithToken?library=${encodeURIComponent(LIBRARY)}&token=${encodeURIComponent(TOKEN)}&callback=${encodeURIComponent(callback)}`;
        window.location.href = url;
    }
    // ========== FIN EXTRACCI√ìN DE TOKEN ==========
    
    // ========== GESTI√ìN DE TEMA DESDE PLATAFORMA ==========
    /**
     * Lee el tema desde m√∫ltiples fuentes (cookie, URL, postMessage) y lo aplica
     * Soporta integraci√≥n con plataforma mediante:
     * 1. Cookie: spaceThemeStore (mismo dominio)
     * 2. URL: ?darkMode=true&primaryColor=%23aea1ff
     * 3. postMessage: para iframes (parent env√≠a tema)
     */
    function aplicarTema(themeData) {
        try {
            console.log('üé® Aplicando tema:', themeData);
            
            // Aplicar modo dark/light
            if (themeData.darkMode === true) {
                document.documentElement.setAttribute('data-theme', 'dark');
                console.log('üåô Modo oscuro aplicado');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                console.log('‚òÄÔ∏è Modo claro aplicado');
            }
            
            // Aplicar color primario personalizado si est√° disponible
            if (themeData.primaryColor) {
                document.documentElement.style.setProperty('--primary', themeData.primaryColor);
                console.log('üé® Color primario personalizado aplicado:', themeData.primaryColor);
            }
            
            return true;
        } catch (error) {
            console.error('‚ùå Error al aplicar tema:', error);
            return false;
        }
    }
    
    function leerTemaDeCookie() {
        try {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'spaceThemeStore') {
                    const spaceThemeCookie = decodeURIComponent(value);
                    console.log('üç™ Cookie de tema encontrada');
                    return JSON.parse(spaceThemeCookie);
                }
            }
        } catch (error) {
            console.error('‚ùå Error al leer cookie:', error);
        }
        return null;
    }
    
    function leerTemaDeURL() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const darkMode = urlParams.get('darkMode');
            const primaryColor = urlParams.get('primaryColor');
            
            if (darkMode !== null) {
                console.log('üîó Par√°metros de tema encontrados en URL');
                return {
                    darkMode: darkMode === 'true',
                    primaryColor: primaryColor || null
                };
            }
        } catch (error) {
            console.error('‚ùå Error al leer par√°metros de URL:', error);
        }
        return null;
    }
    
    function aplicarTemaPlataforma() {
        // Prioridad 1: Leer de Cookie (mismo dominio)
        let themeData = leerTemaDeCookie();
        if (themeData) {
            console.log('‚úÖ Tema obtenido desde Cookie');
            aplicarTema(themeData);
            return;
        }
        
        // Prioridad 2: Leer de URL (iframe o link directo)
        themeData = leerTemaDeURL();
        if (themeData) {
            console.log('‚úÖ Tema obtenido desde URL');
            aplicarTema(themeData);
            return;
        }
        
        // Prioridad 3: Usar tema por defecto
        console.log('‚ÑπÔ∏è No se encontr√≥ configuraci√≥n de tema, usando modo claro por defecto');
        document.documentElement.setAttribute('data-theme', 'light');
    }
    
    // Escuchar mensajes de postMessage (para iframe)
    window.addEventListener('message', (event) => {
        try {
            // Validar que el mensaje tenga el formato esperado
            if (event.data && typeof event.data === 'object' && 'darkMode' in event.data) {
                console.log('üì® Tema recibido via postMessage:', event.data);
                aplicarTema(event.data);
            }
        } catch (error) {
            console.error('‚ùå Error al procesar postMessage:', error);
        }
    });
    
    // Aplicar tema al cargar la p√°gina
    aplicarTemaPlataforma();
    
    // Si est√° en iframe, solicitar tema al parent
    if (window.parent !== window) {
        console.log('üñºÔ∏è Detectado iframe, solicitando tema al parent...');
        window.parent.postMessage({ type: 'requestTheme' }, '*');
    }
    // ========== FIN GESTI√ìN DE TEMA ==========
    
    
    document.addEventListener('DOMContentLoaded', () => {
        // Obtener datos del usuario
        obtenerDatosUsuario();
    });
</script>

</body>
</html>
